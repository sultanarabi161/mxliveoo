<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>mxliveoo</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clappr-playback-rate-plugin@latest/dist/clappr-playback-rate-plugin.min.js"></script>
</head>
<body>

    <div id="playerContainer">
        <div class="player-wrapper">
            <div id="clappr-player"></div>
        </div>
        <div class="player-info">
            <div style="display:flex; justify-content:space-between;">
                <b id="playingTitle" style="font-size:1.1rem;">Select a Channel</b>
                <button onclick="closePlayer()" style="background:none; border:none; color:#aaa;"><i class="fas fa-times"></i> Close</button>
            </div>
            
            <div class="player-actions">
                <a href="https://t.me/YourTelegram" target="_blank" class="btn-action btn-telegram">
                    <i class="fab fa-telegram-plane"></i> Join Telegram
                </a>
                <button class="btn-action" onclick="togglePiP()">
                    <i class="fas fa-external-link-alt"></i> PiP Mode
                </button>
            </div>
        </div>
    </div>

    <header>
        <div class="top-bar">
            <div class="logo">MXLIVEOO</div>
            <div class="actions">
                <i class="fas fa-search" onclick="toggleSearch()"></i>
                <i class="fas fa-sync-alt" onclick="location.reload()"></i>
            </div>
        </div>
        
        <div class="marquee-box">
            <marquee id="noticeMsg">Loading System...</marquee>
        </div>

        <div id="searchBar" style="display:none; padding:10px; background:#222;">
            <input type="text" id="searchInput" placeholder="Search..." style="width:100%; padding:8px; border:none; border-radius:4px;">
        </div>

        <div class="cat-scroll" id="catList"></div>
    </header>

    <main>
        <div id="channelGrid" class="grid-container">
            <div style="grid-column:span 3; text-align:center; padding:20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading Channels...
            </div>
        </div>
    </main>

    <script src="cordova.js"></script>
    <script>
        // কনফিগারেশন
        const M3U_URL = "https://m3u.ch/pl/b3499faa747f2cd4597756dbb5ac2336_e78e8c1a1cebb153599e2d938ea41a50.m3u";
        const NOTICE_URL = "https://raw.githubusercontent.com/sultanarabi161/mxliveoo/main/notice.json";

        let allChannels = [];
        let player = null;
        let activeCat = 'All';

        document.addEventListener('deviceready', init, false);
        window.onload = init; 

        function init() {
            fetchNotice();
            loadChannels();
            
            document.getElementById('searchInput').addEventListener('input', (e) => {
                renderGrid(e.target.value);
            });
        }

        async function fetchNotice() {
            try {
                const req = await fetch(NOTICE_URL);
                const data = await req.json();
                if(data.message) document.getElementById('noticeMsg').innerText = data.message;
            } catch(e) {}
        }

        async function loadChannels() {
            try {
                const req = await fetch(M3U_URL);
                const text = await req.text();
                parseM3U(text);
            } catch(e) {
                document.getElementById('channelGrid').innerHTML = '<p style="color:red; text-align:center; grid-column:span 3;">Failed to load channels.</p>';
            }
        }

        // ফিক্সড: M3U পার্সিং লজিক (ডাবল চ্যানেল ফিক্স)
        function parseM3U(data) {
            allChannels = []; // অ্যারে ক্লিয়ার করা হলো যাতে ডুপ্লিকেট না হয়
            const lines = data.split('\n');
            let tempCh = null;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (line.startsWith('#EXTINF')) {
                    // লোগো খোঁজা
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    const logo = logoMatch ? logoMatch[1] : 'img/default.png';

                    // গ্রুপ খোঁজা
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    const group = groupMatch ? groupMatch[1] : 'Others';

                    // নাম খোঁজা (কমা এর পরের অংশ)
                    let name = line.split(',').pop().trim();

                    tempCh = { name, logo, group };
                } else if (line.startsWith('http')) {
                    if (tempCh) {
                        tempCh.url = line;
                        allChannels.push(tempCh);
                        tempCh = null; // রিসেট
                    }
                }
            });

            setupCategories();
            renderGrid();
        }

        function setupCategories() {
            const categories = ['All', ...new Set(allChannels.map(c => c.group))];
            const catContainer = document.getElementById('catList');
            
            catContainer.innerHTML = categories.map(cat => 
                `<button class="cat-btn ${cat === 'All' ? 'active' : ''}" onclick="filterCat('${cat}')">${cat}</button>`
            ).join('');
        }

        window.filterCat = function(cat) {
            activeCat = cat;
            // বাটন স্টাইল আপডেট
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText === cat) btn.classList.add('active');
            });
            renderGrid();
        }

        function renderGrid(search = "") {
            const grid = document.getElementById('channelGrid');
            grid.innerHTML = "";

            const filtered = allChannels.filter(ch => {
                const inCat = activeCat === 'All' || ch.group === activeCat;
                const inSearch = ch.name.toLowerCase().includes(search.toLowerCase());
                return inCat && inSearch;
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<p style="text-align:center; grid-column:span 3;">No Channels Found</p>';
                return;
            }

            // ব্যাচ রেন্ডারিং (পারফরম্যান্স এর জন্য)
            let html = "";
            filtered.forEach(ch => {
                // সিঙ্গেল কোট বা বিশেষ ক্যারেক্টার এস্কেপ করা
                const safeName = ch.name.replace(/'/g, "\\'");
                const safeUrl = ch.url; 
                
                html += `
                <div class="channel-card" onclick="startPlayer('${safeUrl}', '${safeName}')">
                    <div class="img-box">
                        <img src="${ch.logo}" loading="lazy" onerror="this.src='https://via.placeholder.com/100?text=MX'">
                    </div>
                    <div class="card-title">${ch.name}</div>
                </div>`;
            });
            grid.innerHTML = html;
        }

        // --- CLAPPR PLAYER SETUP ---
        window.startPlayer = function(url, name) {
            // প্লেয়ার সেকশন দেখান
            document.getElementById('playerContainer').style.display = 'block';
            document.getElementById('playingTitle').innerText = name;
            window.scrollTo(0,0); // পেজের উপরে যান

            // আগের প্লেয়ার থাকলে ধ্বংস করুন
            if (player) {
                player.destroy();
                player = null;
            }

            // নতুন Clappr প্লেয়ার তৈরি
            player = new Clappr.Player({
                source: url,
                parentId: "#clappr-player",
                width: '100%',
                height: '100%',
                autoPlay: true,
                plugins: [ClapprPlaybackRatePlugin],
                playback: {
                    playInline: true, // আইফোনের জন্য
                    recycleVideo: true,
                },
                playbackRateConfig: {
                    defaultValue: '1.0',
                    options: [
                        {value: '0.5', label: '0.5x'},
                        {value: '1.0', label: '1x'},
                        {value: '1.5', label: '1.5x'},
                        {value: '2.0', label: '2x'},
                    ]
                }
            });
        }

        window.closePlayer = function() {
            if(player) {
                player.stop();
                player.destroy();
                player = null;
            }
            document.getElementById('playerContainer').style.display = 'none';
        }

        // PiP (Picture in Picture) Logic
        window.togglePiP = function() {
            const videoElement = document.querySelector('video');
            if (videoElement) {
                if (document.pictureInPictureElement) {
                    document.exitPictureInPicture();
                } else if (document.pictureInPictureEnabled) {
                    videoElement.requestPictureInPicture();
                } else {
                    alert("PiP not supported on this device/webview.");
                }
            } else {
                alert("Play a video first!");
            }
        }

        window.toggleSearch = function() {
            const bar = document.getElementById('searchBar');
            bar.style.display = bar.style.display === 'none' ? 'block' : 'none';
            if(bar.style.display === 'block') document.getElementById('searchInput').focus();
        }
    </script>
</body>
</html>
